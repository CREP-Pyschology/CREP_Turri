---
title: "ACREP Updated Analyses"
author: "erin buchanan"
date: "Last Updated `r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Information

Multilab close replication of: Experiment 1 from Turri, J., Buckwalter, W., & Blouw, P. (2015). Knowledge and luck. *Psychonomic Bulletin and Review*, 22, 378-390.

[Data and registered protocols:](https://osf.io/n5b3w/)

[Codebook](https://docs.google.com/spreadsheets/d/1KjXqgfVgguHeDXVtlHHhJ9zsRGVDfPVPH4tbh75P46U/edit#gid=903093128)

[Preprint](https://psyarxiv.com/zeux9/)

## Libraries

```{r}
library(rio)
library(nlme)
library(MuMIn)
library(plyr)
library(psych)
```

## Import the Data

The `full_long` dataset includes all participants in long format - wherein each trial of their study is on one row of the dataset. Our uploaded data also includes `full.Rds` which is the same data in wide format - one column for each variable in the dataset and one row per participant.

```{r}
full_long <- readRDS("./04_Data/rds/d_all_long.Rds")
#str(full_long)
```

Import the open-ended response codes to use for data exclusions.

```{r}
file.names <- list.files(path = "./04_Data/open_responses/", 
                         pattern = ".xlsx", full.names = T, 
                         recursive = T)

previous.files <- lapply(file.names, function(x){ import(x, sheet = 2)})
#purpose.files <- lapply(file.names, function(x){ import(x, sheet = 3)})

previousDF <- do.call(rbind.fill, previous.files)
#purposeDF <- do.call(rbind.fill, purpose.files)
```

## Fix Data Coding / Examine Covariates  

```{r}
# make empty vignettes NA to exclude
# drop empty levels 
full_long$vignette_order[full_long$vignette_order == ""] <- NA
full_long$vignette_order <- droplevels(full_long$vignette_order) 
levels(full_long$vignette_order)

# give compensation type labels 
full_long$comp_type <- factor(full_long$comp_type, 
                              levels = 1:4,
                              labels = c("Credit", "Gift Card", "Money", "Other"))

# how many of each compensation type 
table(full_long$comp_type) / 3 #three rows for each person 

# how many of each gender
table(full_long$gender) / 3

# describe education years
full_long$education <- as.numeric(full_long$education)
describe(full_long$education[!duplicated(full_long$id)])

# age is described below 
```

  (1) if the participant is not the majority age of their country or older (unless parent/guardian waiver provided)

In this section, we will exclude all participants who are under 18 or are not the majority age of their country or older.

https://en.wikipedia.org/wiki/Age_of_majority

```{r}
# table of lab countries
table(full_long$lab_country, useNA = "ifany")

# age information
summary(full_long$age)

# minimum age by country
tapply(full_long$age, full_long$lab_country, min, na.rm = T)

# number of rows
nrow(full_long)
# number of participants
length(unique(full_long$id))

# exclude based on age
full_long$age_exclusion <- NA

age18 <- c("AUT", "AUS", "CAN", "CHE", "DEU", "GBR", "GRC", "HUN", "NOR", "NZL", "POL", "PRT", "ROU", "RUS", "SGP", "TUR", "TWN", "USA")
age19 <- c("SVK")
age21 <- c("ARE")

full_long$age_exclusion[full_long$lab_country %in% age18] <- full_long$age[full_long$lab_country %in% age18] < 18

full_long$age_exclusion[full_long$lab_country %in% age19] <- full_long$age[full_long$lab_country %in% age19] < 19

full_long$age_exclusion[full_long$lab_country %in% age21] <- full_long$age[full_long$lab_country %in% age21] < 21

full_long$age_exclusion[is.na(full_long$age_exclusion)] <- TRUE

full_long$age_exclusion[full_long$age > 100] <- TRUE
```

(2) if the participant has taken part in a previous version of this study or in another contributors' replication of the same study

```{r}
# pull in dictionary 
previousDF$code <- as.character(tolower(previousDF$code))
previousDF$code[previousDF$code == "n/a"] <- "na"
table(previousDF$code)

# coding scheme
previousDF$total <- 0
# previousDF$total[previousDF$code == "yes"] <- previousDF$total[previousDF$code == "yes"] + 2
# previousDF$total[previousDF$code == "na"] <- previousDF$total[previousDF$code == "na"] + 4
# previousDF$total[previousDF$code == "test"] <- previousDF$total[previousDF$code == "test"] + 4

## maybe gets 1 point 
## cut off is four points 
## na gets zero points 
## mark nonsense responses if they are all NA 
```

(3) if the participant fails to answer comprehension questions correctly

```{r}
full_long$studyans_exclusion <- full_long$dge_valid == FALSE
```

(4) if the participant correctly and explicitly articulate knowledge of the specific hypotheses or specific conditions of this study when answering the funneled debriefing questions. 

```{r}
# pull in dictionary 
# subset using dictionary 
full_long$knowledge_exclusion <- NA
```

We will also exclude participants who self-report their understanding of the tested language as "not well" or "not well at all". We based this exclusion criteria on a recent study that found that non-native English speakers who self-report as "very well" and "well" tend to score in the "intermediate" and "basic" categories on an English proficiency test respectively, while those who self-report as "not well" and "not at all" tend to score in the "below basic" category (Vickstrom, Shin, Collazo, & Bauman, 2015). All excluded data will be included in the data files on the overall OSF page, along with the particular reason for why they were excluded. 

```{r}
summary(full_long$language)

full_long$lang_exclusion <- full_long$language == "not very well" | full_long$language == "not well at all" 

full_long$lang_exclusion[is.na(full_long$lang_exclusion)] <- TRUE
```

```{r}
full_long$total_exclusion <- full_long$age_exclusion + full_long$studyans_exclusion + full_long$lang_exclusion #### ADD OTHER TWO

table(full_long$age_exclusion)
table(full_long$lang_exclusion)
table(full_long$studyans_exclusion)
table(full_long$total_exclusion)

final_long <- subset(full_long, total_exclusion < 1)

nrow(full_long)
nrow(final_long)

length(unique(full_long$id))
length(unique(final_long$id))
```





- Control variables include:
  - Language proficiency
  - Debriefing knowledge questions
  - While these are labeled as "control", these variables are used as ways to exclude participants. This section should be relabeled as exclusionary variables. 
  
- Covariates:
  - All demographic and other variables measured at each site included in all data - this sentence should be removed it is completely unclear 
  - Test setting: online versus face to face - this section should be modified since no labs were in person 
  - Test setting: individually versus group - this section should be modified since all was online
  - Test setting: compensated versus uncompensated
  - Age
  - Gender (men/women/other)
  - Years of education 
  
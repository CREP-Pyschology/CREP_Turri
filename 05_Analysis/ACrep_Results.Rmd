---
title: "ACrep_Results.Rmd"
author: "Hannah Moshontz"
date: "Last Updated `r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

*Questions*
- Need to double check that we do not know the order of binary variables within person in the Qualtrics data (and document)
- For binary order, what is "normal" and what is "swapped"? (asked here: https://psych-sci-accelerator.slack.com/archives/C029HKSQAUU/p1638471460121200?thread_ts=1636489085.046400&cid=C029HKSQAUU)
- Why is the age exclusion SO extreme? Many labs mostly collected data from people younger than the age of consent in their country.
- Something is happening with age. A lot of improbably values (mentioned here: https://psych-sci-accelerator.slack.com/archives/C029HKSQAUU/p1638486797125900)
- Is it accurate to say that participants had to correctly answer *all* comprehension questions? What if it was for the Julie / bonus vignette? And were the comprehension questions the correct answer (e.g., Darrel was looking at a red ground squirrel) or also whether Darrel was right or wrong?
- In SSS, were people asked how well they understood English, or how well they understood the language the survey was in?
- I'm not seeing random slope on condition. Do we have an estimate of heterogeneity of the effect by site/lab?

## Purpose

This script generates text for the results section of the ACREP / PSA004 Stage 2 RRR. It also runs the analysis .Rmd.

```{r}
library(janitor)
library(stringr)
library(kableExtra)
library(countrycode)
library(ISOcodes)
```


# Run the analysis script

```{r, child = '../05_Analysis/ACrep_Analysis_V2.Rmd'}
```

# EDA on the analysis set

```{r}
final_long %>% 
  glimpse()
```


A few notes about variables that will be moot when we complete the codebook:
- Person is a unique lab identifier (identifies PI)
- lab_id is a not a unique lab identifier, but rather identifies the undergraduate PI
(and some of these undergraduate PIs were students with the same lab PI)
- lab_country is the variable we are using to identify country/region
- UN_Region groups lab country into larger regions
- source identifies the method of data collection
- id uniquely identifies each participant by concatenating the source (qualtrics vs socscisurvey),
undergraduate PI (lab_id), and the unique identifier (case, which was of a different format depending on source)
- variables ending in valid are logical and identify valid cases (in the "final_long" dataset, there will not be variance)
- variables ending in order indicate the order in which vignettes or condition were presented (varies by participant),
or the order in which binary DVs were presented (for socscisurvey, this varies by person within lab such that people 
were presented with "normal" (*not sure what direction this is*) or "swapped", but for Qualtrics, this was randomized 
within person and so is coded as "mixed" and and we do not have more detailed information about order in the final dataset. also one lab didn't properly randomize.)
- 2104 N are missing age. are these likely test observations? and so this exclusion and over 100 were a way to try to catch the test observations.

# Method

## Participants

```{r}
#create dataset for demographics
final_demographics <- final_long %>% 
  group_by(id) %>%
  slice(1) %>% 
  ungroup() %>% 
  select(id, 
         source,
         contains("exclusion"),
         survey_lang,
         turk,
         language,
         lab_id, 
         Person,
         lab_country,
         country,
         UN_Region,
         gender, 
         gender_other,
         starts_with("ethn_"),
         education,
         education_level,
         starts_with("comp"),
         birth_country,
         case,
         age)

full_demographics <- full_long %>% 
  group_by(id) %>%
  slice(1) %>% 
  ungroup() %>% 
  select(id, 
         source,
         contains("exclusion"),
         survey_lang,
         turk,
         language,
         lab_id, 
         Person,
         lab_country,
         country,
         UN_Region,
         gender, 
         gender_other,
         starts_with("ethn_"),
         education,
         education_level,
         starts_with("comp"),
         birth_country,
         case,
         age)

#error out if count doesn't match
if (length(unique(final_long$id)) != nrow(final_demographics)) STOP

```


Participants were recruited to participate by student researchers at `r length(unique(full_demographics$Person))` data collection sites in `r length(unique(full_long$lab_country)` countries spanning world regions (i.e., `r count(group_by(full_long, UN_Region)) %>% drop_na() %>% arrange(-n) %>% pull(UN_Region) %>% paste(collapse = ", ")`).

The full dataset (the deidentified raw data without any exclusions) is available at osf.io/XXXX. Of the `r nrow(full_demographics)` participants who completed the survey, data from `r nrow(full_demographics) - nrow(final_demographics)`% (_n_ = `r`) of people were excluded. 

Specifically, data were excluded for the following pre-registered reasons:
(1) the participant was not the majority age of their country or older (_n_ = `r nrow(filter(full_demographics, age_exclusion)`); operationalized as at least 18 in all countries except Slovakia (where the age of consent is 19) and United Arab Emirates (where the age of consent is 21));
(2) the participant had taken part in a previous version of this study or in another contributors' replication of the same study (_n_ = `r nrow(filter(full_demographics, previous_exclusion)`;as evaluated by three human coders, as described in Supplement X, Section X);
(3) the participant failed to answer all comprehension questions correctly (_n_ = `r nrow(filter(full_demographics, studyans_exclusion)`; e.g., did not correctly identify what Darrel was looking at in the vignette);
(4) the participant correctly and explicitly articulated knowledge of the specific hypotheses or specific conditions of this study when asked what they thought the study hypothesis was (_n_ = `r nrow(filter(full_demographics, purpose)`; as evaluated by three human coders, as described in Supplement X, Section X);
(5) the participant reported their understanding of the language the survey was written in as "not well" or "not well at all" (_n_ = `r nrow(filter(full_demographics, lang_exclusion)`; see Vickstrom, Shin, Collazo, & Bauman, 2015). 

In addition, data were excluded on the basis of criteria that were not in our preregistration. No clear method was devised to identify test responses, but, at many data collection sites, the students and other researchers executing the study tested their survey link multiple times, resulting in invalid survey observations. The following exclusions were designed to remove these invalid test observations using consistent, reliable criteria: Data were excluded if the participant did not provide an age (_n_ = `r nrow(filter(full_demographics, is.na(age)))`) or listed an age greater than or equal to 100 (_n_ = `r nrow(filter(full_demographics, !(age < 100)))`).

Participants in the analysis sample were `r nrow(final_demographics)` adults recruited to participate by student researchers at `r length(unique(final_long$Person))` data collection sites in `r length(unique(final_long$lab_country)` countries spanning world regions (i.e., `r count(group_by(final_long, UN_Region)) %>% drop_na() %>% arrange(-n) %>% pull(UN_Region) %>% paste(collapse = ", ")`). Data collection sites contributed an average of `r final_demographics %>% group_by(Person) %>% count() %>% pull(n) %>% mean() %>% round(2)` participants to the anlaysis sample (min = `r final_demographics %>% group_by(Person) %>% count() %>% pull(n) %>% min()`, max = `r final_demographics %>% group_by(Person) %>% count() %>% pull(n) %>% max()`). See Table X for a summary of participants' age, years of education, and ethnic/racial identity.

Participants received different kinds of compensation for their completion of the survey (see Table X). Most participants completed the survey using a centralized survey on the data collection platform SocSciSurvey, but a small number of participants completed the survey in Qualtrics (see Table X). Variable names and response options have been harmonized across versions, as described in Supplement X. 

```{r}
final_demographics %>% 
  select(age, education) %>% 
  describe() %>% 
  .[1:2,c(2,3,4,8,9)] %>% 
  kable(digits = 2) %>% 
  kable_styling()
```

```{r}
final_demographics %>% 
  select(comp, contains("ethn_"), turk, source) %>% 
  mutate(source = as.factor(source)) %>% 
  mutate(across(.cols = everything(), ~as.numeric(.x))) %>% 
  select(-ethn_other_text) %>% 
  mutate(comp = comp - 1,
         `centralized survey` = source - 1) %>%  #adjusting numeric values so 0 is no and 1 is yes
  describe()

#Braeden is helping sort out an issue where SSS and QT labs used different ethn categories
#Need to resolve/combine ethn_as_sea_pac, ethn_sa, and ethn_none into the other categories
# Once sorted, we'll make a table of these binary variables
```

```{r}
final_demographics %>% 
  mutate(lab_country_full = countrycode(lab_country, "iso3c", "country.name.en")) %>% 
  tabyl(lab_country_full) %>% 
  arrange(-n) %>% 
  kable(digits = 2, caption = "Number and Percent of Participants by Country") %>% 
  kable_styling()
```

```{r}
survey_lang_table <- final_demographics %>%
  mutate(survey_lang = str_replace_all(survey_lang, "prt", "por"),
         survey_lang = str_replace_all(survey_lang, "zho", "chi")) %>% 
  tabyl(survey_lang) %>% 
  arrange(-n)

for (i in 1:length(survey_lang_table$survey_lang)) {
  
  survey_lang_table$survey_lang[i] <- ISO_639_2$Name[ISO_639_2$Alpha_3_B == survey_lang_table$survey_lang[i]]
  
}

survey_lang_table %>% 
  mutate(survey_lang = str_replace_all(survey_lang, "Greek, Modern \\(1453\\-\\)", "Greek"),
         survey_lang = str_replace_all(survey_lang, "Romanian; Moldavian; Moldovan", "Romanian")) %>% 
  kable(digits = 2, caption = "Number and Percent of Participants by Survey Language") %>% 
  kable_styling()
```


## Procedure

Data collection took place between January 1, 2019 and June 1, 2021. Participants completed an online survey that included a consent form. After providing informed consent, participants read and answered questions about three vignettes whose content and conditions varied according to the random presentation feature in SocSciSurvey and Qualtrics. The vignettes used in the study were selected on the basis of pretesting in English, described in Appendix X. 

Vignette content varied by subject and identification target. In one scenario, Darrel identified prarie dogs vs red speckled ground squirrels (cite original). In another scenario, .... In a third scenario, .... Some student researchers opted to include a fourth scenario that was not included in the present analyses but can be found in Appendix X. 

After each vignette, participants evaluated: 1) whether the subject believes or knows, measured either on a continuous scale from 0 to 100 or as a binary choice;
2) the true correct answer, which functioned as a comprehension question and was measured as a binary choice between the two identification options;
3) the extent to which the subject's belief was unreasonable or reasonable, measured either on a continuous scale from 0 to 100 or as a binary choice;
4) whether or not the subject correctly identified the target.

The Method and Results sections of Empirical Articles should be concise, but complete and accessible. Every Empirical Article should fully describe the procedures necessary to reproduce the study and should fully convey the results of the study. Concisely reported robustness checks are encouraged, and more extensive analyses can be included in Supplemental Material. Results and discussion should be combined to ensure clear and concise communication of findings. Broader theoretical discussion and speculation should be confined to the General Discussion section. Tables and figures may be used as necessary to convey the results.

# Results

# Disclosures

## Preregistration

This subsection of the Disclosures section provides one or more links to any preregistration documentation. If only some of the reported studies were preregistered, this subsection should indicate which ones were and which ones were not.

## Data, materials, and online resources

This subsection provides one or more permanent, persisting links to a public archive (e.g., osf.io, perma.cc, clinicaltrials.gov) where readers can access any code, materials, de-identified data, or other resources . It should also refer to any Supplemental Material that will be posted on the journal’s Web site. If any materials or data are not publicly available, this paragraph should explain why and should note how researchers can access them for research purposes.

## Reporting

For all manuscripts reporting new empirical work, the text in this subsection should state, “We report how we determined our sample size, all data exclusions, all manipulations, and all measures in the study” (see Simmons, Nelson, & Simonsohn, 2011). If any aspect of this statement is untrue or not applicable, the authors should instead explain why (e.g., “This study involved an analysis of existing data rather than new data collection”). For studies not involving new empirical work, authors should verify that they have reported any and all simulations or other analyses they conducted as part of the work.

## Ethical approval 

Authors reporting research involving human subjects should indicate whether the protocol was approved by an institutional review board or similar committee and whether it was carried out in accordance with the provisions of the World Medical Association Declaration of Helsinki (note that the latest version of the Declaration of Helsinki requires preregistration before data collection begins). Authors reporting research involving nonhuman animal subjects should indicate whether institutional and national guidelines for the care and use of laboratory animals were followed. If ethical approval was not required, the reason should be given. Information that could identify subjects will not be published unless the information is necessary and written, informed consent is obtained.

## Author Contributions

Authorship implies significant participation in the research reported or in writing the manuscript, including participation in designing and/or interpreting reported experiments or results, participation in acquiring and/or analyzing data, or participation in drafting and/or revising the manuscript. All authors must agree to the order in which the authors are listed and must have read the final manuscript and approved its submission. They must also agree to take responsibility for the work in the event that its integrity or veracity is questioned. In complete sentences, authors should precisely describe their contributions to the research and manuscript, identifying each author by his or her initials and surname. For example: “D. J. Simons and A. O. Holcombe jointly generated the idea for the study. A. O. Holcombe programmed the study and collected the data. D. J. Simons wrote the analysis code and analyzed the data, and A. O. Holcombe verified the accuracy of those analyses. D. J. Simons wrote the first draft of the manuscript, and both authors critically edited it. Both authors approved the final submitted version of the manuscript.”

## Conflicts of Interest

Authors should identify any conflicts of interest in this section (and should also report them during the submission process). If authors have no conflicts of interest, they should state, “The author(s) declare that there were no conflicts of interest with respect to the authorship or the publication of this article.”

## Acknowledgments

Authors should use this section to identify any people who should be credited for their assistance with the reported research.

## Funding

This section should be used to acknowledge funding sources, in complete sentences and with the full names of funders spelled out.
    
    
## Supplemental Material

If Supplemental Material will be posted on the journal’s Web site, include this heading and the appropriate link will be added during editing.


## Prior versions

If part or all of a submitted manuscript was previously posted to a blog or to a preprint archive, the authors should provide a link to that source and briefly indicate what aspects of the submitted manuscript are shared with that prior version.
